<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rush-Maximizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="background-texture"></div>

    <!-- Startup overlay: blocks the UI until the user connects to a game server and LMStudio -->
    <div id="startup-overlay" class="modal">
    <div class="modal-content startup-modal-content">
            <h2 style="margin:0 0 8px 0;font-family: 'Orbitron', sans-serif;letter-spacing:1px">Rush-Maximizer — 接続</h2>
            <p style="margin:0 0 12px 0;opacity:0.95">ゲームサーバーとLMStudioに接続してください。</p>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <input id="startup-server" type="text" placeholder="http://" style="flex:1;padding:8px;border-radius:6px;border:1px solid #223;">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <input id="startup-lmserver" type="text" placeholder="http://" style="flex:1;padding:8px;border-radius:6px;border:1px solid #223;">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px;">
                <input id="startup-nickname" type="text" placeholder="ニックネーム" style="flex:1;padding:8px;border-radius:6px;border:1px solid #223;">
                <button id="connect-server-btn" class="btn btn-primary" style="padding:8px 12px;">接続して開始</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
                <input id="startup-bgm-enabled" type="checkbox" style="width:16px;height:16px;"> <label for="startup-bgm-enabled" style="color:#cfe">BGMを再生して開始</label>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                <input id="startup-force-lm" type="checkbox" style="width:16px;height:16px;"> <label for="startup-force-lm" style="color:#cfe">LMStudio 接続チェックをスキップ（強制接続）</label>
            </div>
            <div id="connection-status" style="font-size:13px;opacity:0.85">サーバー状態: 未接続</div>
            <div id="lobby-status-container" class="lobby-status" style="margin-top:12px;font-size:13px;opacity:0.9;display:none;">
                <div id="lobby-status"></div>
                <div id="lobby-details"></div>
            </div>
            <div id="lobby-minigame" style="display:none;margin-top:12px;">
                <div style="margin-bottom:8px;">ロビー待機中：ミニゲームで遊んで待とう！</div>
                <div id="minigame-area" style="width:100%;height:120px;background:#071018;border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;">
                    <button id="minigame-btn" style="position:absolute;width:48px;height:48px;border-radius:50%;background:#0ea5a4;border:none;">⚪</button>
                    <div id="minigame-score" style="position:absolute;top:8px;right:12px;color:#fff;font-size:13px;">得点: 0</div>
                </div>
            </div>
            <div style="margin-top:10px;font-size:12px;opacity:0.85">ブラウザでは http(s) で開いてください（file:// は一部機能制限あり）。</div>
        </div>
    </div>

    <!-- Tutorial selection modal -->
    <div id="tutorial-select-modal" class="modal">
        <div class="modal-content" style="max-width:500px;text-align:center;">
            <h2 style="margin-bottom:20px;color:var(--primary-color);">Welcome to Rush-Maximizer!</h2>
            <p style="margin-bottom:30px;line-height:1.6;">
                初回プレイですか？<br>
                チュートリアルでゲームの遊び方を学ぶことをお勧めします。
            </p>
            <div style="display:flex;gap:15px;justify-content:center;">
                <button id="tutorial-yes-btn" class="btn btn-primary" style="padding:12px 24px;">
                    📚 チュートリアルを開始
                </button>
                <button id="tutorial-no-btn" class="btn btn-secondary" style="padding:12px 24px;">
                    ⏭️ スキップしてメニューへ
                </button>
            </div>
        </div>
    </div>

    <!-- Tutorial overlay (hidden by default; shown when tutorial active) -->
    <div id="tutorial-overlay" class="tutorial-overlay">
        <div class="tutorial-content">
            <div style="position:relative;">
                <div id="tutorial-counter" class="tutorial-step-counter"></div>
            </div>
            <div class="tutorial-step" id="tutorial-step">
                <h3 id="tutorial-title">チュートリアル</h3>
                <p id="tutorial-description">チュートリアルを開始します...</p>
                <div class="tutorial-actions">
                    <button id="tutorial-prev-btn" class="btn btn-secondary" style="display:none;">← 前へ</button>
                    <button id="tutorial-next-btn" class="btn btn-primary">次へ →</button>
                    <button id="tutorial-skip-btn" class="btn btn-secondary">スキップ</button>
                </div>
            </div>
        </div>
        <div class="tutorial-highlight" id="tutorial-highlight"></div>
    </div>

    <div id="main-menu" class="screen">
        <div class="menu-container">
            <div class="game-title">
                <h1>RUSH MAXIMIZER</h1>
                <p class="subtitle">AIを知識で誘導してモノにする新感覚クイズ</p>
            </div>
            <div class="menu-buttons">
                <button class="menu-btn" id="solo-mode-btn">
                    <span class="btn-icon">🎯</span>
                    <span class="btn-text">ソロモード</span>
                    <span class="btn-desc">時間無制限でじっくり挑戦</span>
                </button>
                <button class="menu-btn" id="vs-mode-btn">
                    <span class="btn-icon">⚔️</span>
                    <span class="btn-text">対戦モード</span>
                    <span class="btn-desc">オンラインで対戦</span>
                </button>
                <button class="menu-btn" id="rta-mode-btn">
                    <span class="btn-icon">⏱️</span>
                    <span class="btn-text">RTAモード</span>
                    <span class="btn-desc">10問 / 3分のタイムアタック</span>
                </button>
                <button class="menu-btn" id="practice-mode-btn">
                    <span class="btn-icon">📚</span>
                    <span class="btn-text">練習モード</span>
                    <span class="btn-desc">好きな問題数で練習</span>
                </button>
            </div> <!-- /.menu-buttons -->
            <div class="tab-content" id="server-tab" style="display:none;">
                <div class="form-group">
                    <label for="game-server-address">ゲームサーバーアドレス:</label>
                    <!-- hidden duplicate removed -->
                </div>
                <div class="form-group">
                    <label for="lm-server-address">LMStudioサーバーアドレス:</label>
                    <!-- hidden duplicate removed -->
                </div>
            </div>
            <span id="server-stats">サーバー情報: 取得中...</span>
        </div> <!-- /.menu-container -->
    </div> <!-- /#main-menu -->

    <div id="game-screen" class="screen">
        <!-- Futuristic HUD-style header -->
    <div class="game-hud">
            <div class="hud-top">
                <button id="back-to-menu-btn" class="hud-btn exit-btn">✕</button>
                <div class="hud-center">
                    <div class="target-display">
                        <div class="target-label">TARGET</div>
                        <div id="target-answer" class="target-value">江戸城無血開城</div>
                    </div>
                </div>
                <div class="hud-right">
                    <div class="progress-ring" id="progress-ring">
                        <svg width="60" height="60">
                            <circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="4"/>
                            <circle cx="30" cy="30" r="25" fill="none" stroke="#00d4ff" stroke-width="4" 
                                    stroke-dasharray="157" stroke-dashoffset="157" id="progress-circle"/>
                        </svg>
                        <div class="progress-text">
                            <span id="question-number">1</span>/<span id="total-questions">10</span>
                        </div>
                    </div>
                    <div id="vs-countdown-small" class="vs-countdown-small" style="display:none;">残り 60</div>
                </div>
            </div>
            <div class="hud-bottom">
                <div class="hud-stats">
                    <div class="stat-item">
                        <span class="stat-label">MODE</span>
                        <span class="stat-value" id="current-mode">SOLO</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">SCORE</span>
                        <span class="stat-value" id="current-score">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ACCURACY</span>
                        <span class="stat-value" id="accuracy">0%</span>
                    </div>
                    <div class="stat-item timer-wrapper">
                        <span class="stat-label">TIME</span>
                        <span class="stat-value" id="timer-display">05:00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main game area -->
            <div class="game-arena">
            <!-- Left: Player input / history -->
            <div class="arena-left">
                <div class="input-zone">
                    <div class="zone-header">
                        <h3>YOUR STRATEGY</h3>
                        <div class="question-counter">
                            <span id="question-count">QUESTIONS: 0</span>
                        </div>
                    </div>
                    <div class="input-area">
                        <div class="question-history" id="question-history"></div>
                        <div class="input-controls">
                            <textarea id="player-question" class="question-input player-textarea" 
                                      placeholder="AIを正解に導く戦略的な質問を入力..."></textarea>
                            <div class="control-buttons">
                                <button id="clear-question-btn" class="control-btn clear-btn">CLEAR</button>
                                <button id="pass-btn" class="control-btn pass-btn">PASS</button>
                                <button id="submit-question-btn" class="control-btn submit-btn">SEND</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: AI response -->
            <div class="arena-right">
                <div class="ai-zone">
                    <div class="zone-header">
                        <h3>AI RESPONSE</h3>
                        <div class="ai-status-indicator">
                            <div class="status-dot" id="ai-status-dot"></div>
                            <span id="ai-status">WAITING</span>
                        </div>
                    </div>
                    <div class="ai-output-container">
                        <div id="ai-output" class="ai-text">AIが回答を待っています...</div>
                        <div id="ai-analysis" class="ai-analysis"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="modal-content result-content">
            <div class="result-header">
                <h2 id="result-title">ゲーム終了</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="result-body">
                <div class="final-score">
                    <span class="score-label">最終スコア</span>
                    <span class="score-number" id="final-score">0</span>
                </div>
                <div class="result-stats">
                    <div class="stat-item">
                        <span class="stat-label">正解数</span>
                        <span class="stat-value" id="result-correct">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">質問数</span>
                        <span class="stat-value" id="result-questions">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">精度</span>
                        <span class="stat-value" id="result-accuracy">0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">所要時間</span>
                        <span class="stat-value" id="result-time">00:00</span>
                    </div>
                </div>
                <div class="new-achievements" id="new-achievements"></div>
                <!-- Multiplayer ranking list populated after game finish -->
                <div id="result-ranking-list" style="margin-top:12px;"></div>
                <div class="result-actions">
                    <button class="btn btn-primary" id="play-again-btn">もう一度プレイ</button>
                    <button class="btn btn-secondary" id="back-to-menu-result-btn">メニューに戻る</button>
                </div>
                <div style="margin-top:12px;text-align:center;color:var(--text-secondary);font-size:0.9rem;">
                    自動でメニューに戻るまで: <span id="auto-return-countdown">15</span> 秒
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>設定</h2>
            <div class="settings-tabs">
                <button class="tab-btn active" data-tab="display">表示</button>
                <button class="tab-btn" data-tab="server">サーバー</button>
            </div>
            <div class="tab-content active" id="display-tab">
                <div class="form-group">
                    <label for="theme">テーマ:</label>
                    <select id="theme">
                        <option value="dark">ダーク</option>
                        <option value="light">ライト</option>
                        <option value="cyberpunk">サイバーパンク</option>
                    </select>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="sound-effects" checked>
                    <label for="sound-effects">効果音</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="animations" checked>
                    <label for="animations">アニメーション</label>
                </div>
            </div>
            <div class="tab-content" id="server-tab">
                <div class="form-group">
                    <label for="game-server-address">ゲームサーバーアドレス:</label>
                    <input type="text" id="game-server-address" placeholder="http://localhost:8000">
                </div>
                <div class="form-group">
                    <label for="lm-server-address">LMStudioサーバーアドレス:</label>
                    <input type="text" id="lm-server-address" placeholder="http://localhost:1234">
                </div>
            </div>
            <button id="save-settings-btn" class="btn btn-primary">設定を保存</button>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal">
        <div class="modal-content leaderboard-content">
            <div class="modal-header">
                <h2>ランキング</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="leaderboard-tabs">
                <button class="tab-btn active" data-board="solo">ソロ</button>
                <button class="tab-btn" data-board="rta">RTA</button>
            </div>
            <div class="leaderboard-content">
                <div id="leaderboard-list"></div>
            </div>
        </div>
    </div>

    <div id="achievements-modal" class="modal">
        <div class="modal-content achievements-content">
            <div class="modal-header">
                <h2>実績</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="achievements-content">
                <div id="achievements-list"></div>
            </div>
        </div>
    </div>

    <div id="controls-overlay" class="modal">
        <div class="modal-content" id="controls-content">
            <h2>操作方法</h2>
            <div class="form-group">
                <p>テキストでAIに質問して、AIが「TARGET」を回答するまで誘導してください。</p>
                <p>主な操作: テキスト入力 → Ctrl+Enter（または「質問する」ボタン）で送信</p>
                <p>ヒントが必要なら「💡 ヒント」, 問題を飛ばすなら「次の問題」</p>
            </div>
            <div class="result-actions">
                <button class="btn btn-primary" id="controls-start-btn">始める</button>
                <button class="btn btn-secondary" id="controls-back-btn">メニューに戻る</button>
            </div>
        </div>
    </div>

    <!-- Large countdown overlay -->
    <div id="big-countdown" class="countdown-overlay">
        <div id="big-count-number" class="count-number">3</div>
    </div>

    <!-- Practice setup modal -->
    <div id="practice-setup-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>練習モード設定</h2>
            <div class="form-group">
                <label for="practice-questions">問題数:</label>
                <input type="number" id="practice-questions" min="1" max="100" value="10">
            </div>
            <div class="form-group">
                <label for="practice-time">制限時間（分）:</label>
                <input type="number" id="practice-time" min="1" max="60" value="5">
            </div>
            <div class="result-actions">
                <button class="btn btn-primary" id="practice-start-btn">練習を開始</button>
            </div>
        </div>
    </div>

    <!-- Match type selection modal -->
    <div id="match-select-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>対戦モードを選択</h2>
            <div class="menu-buttons" style="flex-direction: column;">
                <button class="menu-btn" id="match-random-btn">
                    <span class="btn-icon">🎲</span>
                    <span class="btn-text">ランダムマッチ</span>
                    <span class="btn-desc">世界中のプレイヤーと自動で対戦</span>
                </button>
                <button class="menu-btn" id="match-custom-btn">
                    <span class="btn-icon">🤝</span>
                    <span class="btn-text">カスタムルーム</span>
                    <span class="btn-desc">友達と合言葉を決めて対戦</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Random match rule selection modal -->
    <div id="random-match-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>ランダムマッチ ルール選択</h2>
            <div class="form-group">
                <label for="random-rule-select">ルールを選択してください:</label>
                <select id="random-rule-select">
                    <option value="classic">クラシック</option>
                    <option value="speed">スピード</option>
                    <option value="challenge">チャレンジ</option>
                </select>
            </div>
            <div id="rule-description" class="rule-description">
                <p><b>クラシック:</b> 標準的なルールです。10問の問題に挑戦し、スコアを競います。</p>
            </div>
            <div class="result-actions">
                <button class="btn btn-primary" id="random-join-btn">このルールでマッチング開始</button>
            </div>
        </div>
    </div>

    <!-- Room modal for creating/joining custom rooms -->
    <div id="room-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>カスタムルーム</h2>
            <div class="room-container">
                <div class="room-section">
                    <h3>ルームを作成</h3>
                    <div class="form-group">
                        <label>ルーム名</label>
                        <input type="text" id="room-name" placeholder="任意のルーム名">
                    </div>
                    <div class="form-group">
                        <label>パスワード（任意）</label>
                        <input type="password" id="room-password" placeholder="パスワード">
                    </div>
                    <div class="form-group">
                        <label>最大プレイヤー数</label>
                        <input type="number" id="room-max" min="2" max="50" value="3">
                    </div>
                    <div class="form-group">
                        <label>ルール</label>
                        <select id="room-rule">
                            <option value="classic">クラシック (標準)</option>
                            <option value="speed">スピード (短め)</option>
                            <option value="challenge">チャレンジ (問題多め)</option>
                        </select>
                    </div>
                    <div><button class="btn btn-primary" id="create-room-btn">ルームを作成</button></div>
                </div>
                <div class="room-section">
                    <h3>ルームに参加</h3>
                    <div class="form-group">
                        <label>ルームID</label>
                        <input type="text" id="join-room-id" placeholder="ルームIDを入力">
                    </div>
                    <div class="form-group">
                        <label>パスワード（必要なら）</label>
                        <input type="password" id="join-room-password" placeholder="パスワード">
                    </div>
                    <div><button class="btn btn-primary" id="join-room-btn">参加する</button></div>
                </div>
            </div>
            <div id="room-status" class="room-status"></div>

    <script src="js/config.js"></script>
    <script src="js/debugger.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js?v=2.0"></script>

    <!-- Persistent Status Indicators -->
    <div id="persistent-status-container" style="display:none;">
    <div id="matchmaking-status"></div>
    <span class="waiting-badge" style="display:inline-block;">-</span>
    <button id="cancel-matchmaking-btn" class="btn btn-secondary">キャンセル</button>
    </div>

    <!-- Quick floating cancel button for matchmaking (shown when matchmaking active) -->
    <button id="quick-cancel-btn" class="btn-quick-cancel" style="display:none;">キャンセル</button>

    <div id="match-found-modal" class="modal">
        <div class="modal-content">
            <h2>対戦相手が見つかりました！</h2>
            <p>まもなくゲームを開始します...</p>
            <div id="match-found-countdown">5</div>
        </div>
    </div>

</body>
</html>
