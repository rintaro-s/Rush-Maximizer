<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rush-Maximizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="background-texture"></div>

    <!-- Startup overlay: blocks the UI until the user connects to a game server and LMStudio -->
    <div id="startup-overlay" class="modal">
    <div class="modal-content startup-modal-content">
            <h2 style="margin:0 0 8px 0;font-family: 'Orbitron', sans-serif;letter-spacing:1px">Rush-Maximizer — 接続</h2>
            <p style="margin:0 0 12px 0;opacity:0.95">ゲームサーバーとLMStudioに接続してください。</p>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <input id="startup-server" type="text" placeholder="http://" style="flex:1;padding:8px;border-radius:6px;border:1px solid #223;">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
                <input id="startup-lmserver" type="text" placeholder="http://" style="flex:1;padding:8px;border-radius:6px;border:1px solid #223;">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px;">
                <input id="startup-nickname" type="text" placeholder="ニックネーム" style="flex:1;padding:8px;border-radius:6px;border:1px solid #223;">
                <button id="connect-server-btn" class="btn btn-primary" style="padding:8px 12px;">接続して開始</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
                <input id="startup-bgm-enabled" type="checkbox" style="width:16px;height:16px;"> <label for="startup-bgm-enabled" style="color:#cfe">BGMを再生して開始</label>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                <input id="startup-force-lm" type="checkbox" style="width:16px;height:16px;"> <label for="startup-force-lm" style="color:#cfe">LMStudio 接続チェックをスキップ（強制接続）</label>
            </div>
            <div id="connection-status" style="font-size:13px;opacity:0.85">サーバー状態: 未接続</div>
            <div id="lobby-status-container" class="lobby-status" style="margin-top:12px;font-size:13px;opacity:0.9;display:none;">
                <div id="lobby-status"></div>
                <div id="lobby-details"></div>
            </div>
            <div id="lobby-minigame" style="display:none;margin-top:12px;">
                <div style="margin-bottom:8px;">ロビー待機中：ミニゲームで遊んで待とう！</div>
                <div id="minigame-area" style="width:100%;height:120px;background:#071018;border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;">
                    <button id="minigame-btn" style="position:absolute;width:48px;height:48px;border-radius:50%;background:#0ea5a4;border:none;">⚪</button>
                    <div id="minigame-score" style="position:absolute;top:8px;right:12px;color:#fff;font-size:13px;">得点: 0</div>
                </div>
            </div>
            <div style="margin-top:10px;font-size:12px;opacity:0.85">ブラウザでは http(s) で開いてください（file:// は一部機能制限あり）。</div>
        </div>
    </div>

    <!-- Tutorial selection modal -->
    <div id="tutorial-select-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width:500px;text-align:center;">
            <h2 style="margin-bottom:20px;color:var(--primary-color);">Welcome to Rush-Maximizer!</h2>
            <p style="margin-bottom:30px;line-height:1.6;">
                初回プレイですか？<br>
                チュートリアルでゲームの遊び方を学ぶことをお勧めします。
            </p>
            <div style="display:flex;gap:15px;justify-content:center;">
                <button id="tutorial-yes-btn" class="btn btn-primary" style="padding:12px 24px;">
                    📚 チュートリアルを開始
                </button>
                <button id="tutorial-no-btn" class="btn btn-secondary" style="padding:12px 24px;">
                    ⏭️ スキップしてメニューへ
                </button>
            </div>
        </div>
    </div>

    <!-- Tutorial overlay (hidden by default; shown when tutorial active) -->
    <div id="tutorial-overlay" class="tutorial-overlay" style="display: none;">
        <div class="tutorial-content">
            <div style="position:relative;">
                <div id="tutorial-counter" class="tutorial-step-counter"></div>
            </div>
            <div class="tutorial-step" id="tutorial-step">
                <h3 id="tutorial-title">チュートリアル</h3>
                <p id="tutorial-description">チュートリアルを開始します...</p>
                <div class="tutorial-actions">
                    <button id="tutorial-prev-btn" class="btn btn-secondary" style="display:none;">← 前へ</button>
                    <button id="tutorial-next-btn" class="btn btn-primary">次へ →</button>
                    <button id="tutorial-skip-btn" class="btn btn-secondary">スキップ</button>
                </div>
            </div>
        </div>
        <div class="tutorial-highlight" id="tutorial-highlight"></div>
    </div>

    <div id="main-menu" class="screen">
        <div class="glassmorphism-container">
            <div class="main-header">
                <div class="logo-section">🧠
                    <h1 class="app-title">
                        <span class="title-icon"></span>
                        <span class="title-text">Rush Maximizer</span>
                    </h1>
                    <p class="app-subtitle">AIを使った新感覚クイズゲーム</p>
                </div>
                
                <div class="quick-actions">
                    <button class="icon-btn settings-btn" onclick="gameManager.showModal('settings-modal')">
                        <span class="icon">⚙️</span>
                    </button>
                    <!-- Leaderboard removed -->
                    <button class="icon-btn tutorial-btn" onclick="gameManager.showModal('tutorial-select-modal')">
                        <span class="icon">❓</span>
                    </button>
                </div>
            </div>

            <div class="menu-content">
                <div class="mode-grid">
                    <div class="mode-card" id="solo-mode-btn">
                        <div class="card-header">
                            <span class="mode-icon">🎯</span>
                            <h3 class="mode-title">ソロモード</h3>
                        </div>
                        <p class="mode-description">時間無制限でじっくり挑戦<br>17秒/問題の新ルール</p>
                        <div class="mode-stats">
                            <span class="stat-badge">制限時間なし</span>
                            <span class="stat-badge">10問</span>
                        </div>
                    </div>

                    <div class="mode-card" id="vs-mode-btn">
                        <div class="card-header">
                            <span class="mode-icon">⚔️</span>
                            <h3 class="mode-title">対戦モード</h3>
                        </div>
                        <p class="mode-description">オンラインで他プレイヤーと競争<br>パス3回まで可能</p>
                        <div class="mode-stats">
                            <span class="stat-badge">リアルタイム</span>
                            <span class="stat-badge">マルチプレイ</span>
                        </div>
                    </div>

                    <div class="mode-card" id="rta-mode-btn">
                        <div class="card-header">
                            <span class="mode-icon">⏱️</span>
                            <h3 class="mode-title">RTAモード</h3>
                        </div>
                        <p class="mode-description">10問 / 3分のタイムアタック<br>時間で点数が変動</p>
                        <div class="mode-stats">
                            <span class="stat-badge">3分</span>
                            <span class="stat-badge">高速</span>
                        </div>
                    </div>

                    <div class="mode-card" id="practice-mode-btn">
                        <div class="card-header">
                            <span class="mode-icon">📚</span>
                            <h3 class="mode-title">練習モード</h3>
                        </div>
                        <p class="mode-description">カテゴリー・難易度を選択<br>カスタム練習</p>
                        <div class="mode-stats">
                            <span class="stat-badge">フィルター</span>
                            <span class="stat-badge">自由設定</span>
                        </div>
                    </div>
                </div>

                <div class="server-info-panel">
                    <div class="connection-status">
                        <span class="status-indicator" id="connection-indicator"></span>
                        <span id="server-stats">サーバー情報: 取得中...</span>
                    </div>
                    <div class="voice-status">
                        <button class="voice-toggle-btn" id="voice-toggle">
                            <span class="icon">🎤</span>
                            <span class="text">音声認識</span>
                            <span class="status">OFF</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- /#main-menu -->

    <div id="game-screen" class="screen">
        <!-- New glassmorphism game layout -->
        <div class="game-container">
            <!-- Header with target and timers -->
            <div class="game-header">
                <button id="back-to-menu-btn" class="glass-btn exit-btn">
                    <span class="icon">✕</span>
                    <span class="text">メニュー</span>
                </button>
                
                <div class="target-section">
                    <div class="target-label">TARGET ANSWER</div>
                    <div id="target-answer" class="target-display">江戸城無血開城</div>
                </div>
                
                <div class="timer-section">
                    <div class="timer-grid">
                        <div class="timer-item game-timer">
                            <span class="timer-label">GAME TIME</span>
                            <span id="timer-display" class="timer-value">05:00</span>
                        </div>
                        <div class="timer-item question-timer">
                            <span class="timer-label">QUESTION</span>
                            <div class="timer-with-progress">
                                <svg class="progress-circle" width="60" height="60">
                                    <circle cx="30" cy="30" r="25" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#00d4ff" stroke-width="3" 
                                            stroke-dasharray="157" stroke-dashoffset="0" id="question-progress-circle"
                                            transform="rotate(-90 30 30)"/>
                                </svg>
                                <span id="question-timer" class="timer-value overlay">17s</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-info">
                            <span id="question-number">1</span>/<span id="total-questions">10</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game stats panel -->
            <div class="stats-panel">
                <div class="stat-group">
                    <div class="stat-card">
                        <span class="stat-label">MODE</span>
                        <span class="stat-value" id="current-mode">SOLO</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">CORRECT</span>
                        <span class="stat-value" id="current-score">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">ACCURACY</span>
                        <span class="stat-value" id="accuracy">0%</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">QUESTIONS</span>
                        <span class="stat-value" id="question-count">0</span>
                    </div>
                </div>
                
                <!-- Pass counter for VS mode -->
                <div class="pass-counter" id="pass-counter" style="display: none;">
                    <span class="pass-label">PASSES</span>
                    <div class="pass-indicators">
                        <span class="pass-dot active" data-pass="1"></span>
                        <span class="pass-dot active" data-pass="2"></span>
                        <span class="pass-dot active" data-pass="3"></span>
                    </div>
                </div>

                <!-- Voice recognition status -->
                <div class="voice-indicator" id="voice-indicator">
                    <span class="voice-icon">🎤</span>
                    <span class="voice-status">待機中</span>
                </div>
            </div>

            <!-- Main game content -->
            <div class="game-content">
                <!-- Input section -->
                <div class="input-section">
                    <div class="input-header">
                        <h3>戦略的質問入力</h3>
                        <div class="input-actions">
                            <button class="glass-btn voice-btn" id="voice-input-btn">
                                <span class="icon">🎤</span>
                                <span class="text">音声入力</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <textarea id="player-question" class="glass-input" 
                                  placeholder="AIを正解に導く戦略的な質問を入力してください..."></textarea>
                        <div class="input-controls">
                            <button id="clear-question-btn" class="glass-btn secondary">
                                <span class="icon">🗑️</span>
                                <span class="text">クリア</span>
                            </button>
                            <button id="pass-btn" class="glass-btn warning">
                                <span class="icon">⏭️</span>
                                <span class="text">パス</span>
                            </button>
                            <button id="submit-question-btn" class="glass-btn primary">
                                <span class="icon"></span>
                                <span class="text">送信</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI Response section -->
                <div class="ai-section">
                    <div class="ai-header">
                        <h3>AI応答</h3>
                        <div class="ai-status">
                            <span class="status-indicator" id="ai-status-indicator"></span>
                            <span id="ai-status-text">待機中</span>
                        </div>
                    </div>
                    
                    <div class="ai-response">
                        <div id="ai-output" class="ai-text">AIが回答を待っています...</div>
                    </div>
                    
                    <div class="ai-analysis" id="ai-analysis"></div>
                </div>

                <!-- Question history sidebar -->
                <div class="history-section">
                    <div class="history-header">
                        <h3>質問履歴</h3>
                        <span class="history-count" id="history-count">0件</span>
                    </div>
                    <div class="question-history" id="question-history"></div>
                </div>
            </div>

            <!-- VS Mode progress bars (hidden by default) -->
            <div class="vs-progress-panel" id="vs-progress-panel" style="display: none;">
                <h3>対戦状況</h3>
                <div class="player-progress-list" id="player-progress-list">
                    <!-- Dynamic player progress bars will be inserted here -->
                </div>
            </div>
        </div>
                                <button id="clear-question-btn" class="control-btn clear-btn">CLEAR</button>
                                <button id="pass-btn" class="control-btn pass-btn">PASS</button>
                                <button id="submit-question-btn" class="control-btn submit-btn">SEND</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Removed legacy duplicated AI response panel -->
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="modal-content result-content">
            <div class="result-header">
                <h2 id="result-title">ゲーム終了</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="result-body">
                <div class="final-score">
                    <span class="score-label">正解数</span>
                    <span class="score-number" id="final-score">0</span>
                </div>
                <div class="result-stats">
                    <div class="stat-item">
                        <span class="stat-label">正解数</span>
                        <span class="stat-value" id="result-correct">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">質問数</span>
                        <span class="stat-value" id="result-questions">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">精度</span>
                        <span class="stat-value" id="result-accuracy">0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">所要時間</span>
                        <span class="stat-value" id="result-time">00:00</span>
                    </div>
                </div>
                <div class="new-achievements" id="new-achievements"></div>
                <!-- Ranking removed -->
                <div class="result-actions">
                    <button class="btn btn-primary" id="play-again-btn">もう一度プレイ</button>
                    <button class="btn btn-secondary" id="back-to-menu-result-btn">メニューに戻る</button>
                </div>
                <div style="margin-top:12px;text-align:center;color:var(--text-secondary);font-size:0.9rem;">
                    自動でメニューに戻るまで: <span id="auto-return-countdown">15</span> 秒
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>設定</h2>
            <div class="settings-tabs">
                <button class="tab-btn active" data-tab="display">表示</button>
                <button class="tab-btn" data-tab="server">サーバー</button>
            </div>
            <div class="tab-content active" id="display-tab">
                <div class="form-group">
                    <label for="theme">テーマ:</label>
                    <select id="theme">
                        <option value="glassmorphism">グラスモーフィズム</option>
                        <option value="gaming">ゲーミング</option>
                        <option value="light">ライト</option>
                        <option value="cyberpunk">サイバーパンク</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ui-layout">UIレイアウト:</label>
                    <select id="ui-layout">
                        <option value="standard">標準</option>
                        <option value="compact">コンパクト</option>
                        <option value="wide">ワイド</option>
                        <option value="minimal">ミニマル</option>
                    </select>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="sound-effects" checked>
                    <label for="sound-effects">効果音</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="animations" checked>
                    <label for="animations">アニメーション</label>
                </div>
            </div>
            <div class="tab-content" id="server-tab">
                <div class="form-group">
                    <label for="game-server-address">ゲームサーバーアドレス:</label>
                    <input type="text" id="game-server-address" placeholder="http://localhost:8000">
                </div>
                <div class="form-group">
                    <label for="lm-server-address">LMStudioサーバーアドレス:</label>
                    <input type="text" id="lm-server-address" placeholder="http://localhost:1234">
                </div>
            </div>
            <button id="save-settings-btn" class="btn btn-primary">設定を保存</button>
        </div>
    </div>

    <!-- Leaderboard removed -->

    <div id="achievements-modal" class="modal">
        <div class="modal-content achievements-content">
            <div class="modal-header">
                <h2>実績</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="achievements-content">
                <div id="achievements-list"></div>
            </div>
        </div>
    </div>

    <div id="controls-overlay" class="modal">
        <div class="modal-content" id="controls-content">
            <h2>操作方法</h2>
            <div class="form-group">
                <p>テキストでAIに質問して、AIが「TARGET」を回答するまで誘導してください。</p>
                <p>主な操作: テキスト入力 → Ctrl+Enter（または「質問する」ボタン）で送信</p>
                <p>ヒントが必要なら「💡 ヒント」, 問題を飛ばすなら「次の問題」</p>
            </div>
            <div class="result-actions">
                <button class="btn btn-primary" id="controls-start-btn">始める</button>
                <button class="btn btn-secondary" id="controls-back-btn">メニューに戻る</button>
            </div>
        </div>
    </div>

    <!-- Large countdown overlay -->
    <div id="big-countdown" class="countdown-overlay">
        <div id="big-count-number" class="count-number">3</div>
    </div>

    <!-- Practice setup modal -->
    <div id="practice-setup-modal" class="modal">
        <div class="modal-content practice-setup-content">
            <div class="modal-header">
                <h2>練習モード設定</h2>
                <span class="close-btn">&times;</span>
            </div>
            
            <div class="practice-tabs">
                <button class="tab-btn active" data-tab="basic-settings">基本設定</button>
                <button class="tab-btn" data-tab="filter-settings">フィルター</button>
                <button class="tab-btn" data-tab="custom-questions">カスタム問題</button>
            </div>

            <div class="tab-content active" id="basic-settings">
                <div class="form-group">
                    <label for="practice-questions">問題数:</label>
                    <input type="number" id="practice-questions" min="1" max="100" value="10">
                </div>
                <div class="form-group">
                    <label for="practice-time">制限時間（分）:</label>
                    <input type="number" id="practice-time" min="1" max="60" value="5">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="practice-voice" checked>
                    <label for="practice-voice">音声認識を有効にする</label>
                </div>
            </div>

            <div class="tab-content" id="filter-settings" style="display: none;">
                <div class="form-group">
                    <label for="category-filter">カテゴリー:</label>
                    <select id="category-filter" multiple>
                        <option value="all" selected>すべて</option>
                        <option value="history">歴史</option>
                        <option value="science">科学</option>
                        <option value="literature">文学</option>
                        <option value="geography">地理</option>
                        <option value="culture">文化</option>
                        <option value="sports">スポーツ</option>
                        <option value="entertainment">エンターテイメント</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="difficulty-filter">難易度:</label>
                    <div class="difficulty-options">
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="all" checked>
                            <span>すべて</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="easy">
                            <span>初級</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="medium">
                            <span>中級</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="difficulty" value="hard">
                            <span>上級</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tag-filter">タグ:</label>
                    <div class="tag-options">
                        <label class="checkbox-option">
                            <input type="checkbox" value="famous">
                            <span>有名人</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" value="places">
                            <span>地名</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" value="events">
                            <span>出来事</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" value="objects">
                            <span>物</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" value="concepts">
                            <span>概念</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="custom-questions" style="display: none;">
                <div class="custom-options">
                    <div class="custom-option-card">
                        <h3>ゲーム内で作成</h3>
                        <p>問題と答えを入力して、オリジナル問題集を作成</p>
                        <button class="btn btn-secondary" id="create-custom-btn">問題を作成</button>
                    </div>
                    <div class="custom-option-card">
                        <h3>JSONファイル読み込み</h3>
                        <p>JSONファイルをアップロードして問題集を読み込み</p>
                        <div class="file-upload">
                            <input type="file" id="json-upload" accept=".json" style="display: none;">
                            <button class="btn btn-secondary" onclick="document.getElementById('json-upload').click()">
                                ファイルを選択
                            </button>
                            <span id="file-name"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="question-preview">
                    <span id="filtered-count">利用可能な問題: 計算中...</span>
                </div>
                <div class="result-actions">
                    <button class="btn btn-secondary" onclick="gameManager.closeModal('practice-setup-modal')">キャンセル</button>
                    <button class="btn btn-primary" id="practice-start-btn">練習を開始</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Match type selection modal -->
    <div id="match-select-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>対戦モードを選択</h2>
            <div class="menu-buttons" style="flex-direction: column;">
                <button class="menu-btn" id="match-random-btn">
                    <span class="btn-icon">🎲</span>
                    <span class="btn-text">ランダムマッチ</span>
                    <span class="btn-desc">世界中のプレイヤーと自動で対戦</span>
                </button>
                <button class="menu-btn" id="match-custom-btn">
                    <span class="btn-icon">🤝</span>
                    <span class="btn-text">カスタムルーム</span>
                    <span class="btn-desc">友達と合言葉を決めて対戦</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Random match rule selection modal -->
    <div id="random-match-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>ランダムマッチ ルール選択</h2>
            <div class="form-group">
                <label for="random-rule-select">ルールを選択してください:</label>
                <select id="random-rule-select">
                    <option value="classic">クラシック</option>
                    <option value="speed">スピード</option>
                    <option value="challenge">チャレンジ</option>
                </select>
            </div>
            <div id="rule-description" class="rule-description">
                <p><b>クラシック:</b> 標準的なルールです。10問の問題に挑戦し、スコアを競います。</p>
            </div>
            <div class="result-actions">
                <button class="btn btn-primary" id="random-join-btn">このルールでマッチング開始</button>
            </div>
        </div>
    </div>

    <!-- Room modal for creating/joining custom rooms -->
    <div id="room-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>カスタムルーム</h2>
            <div class="room-container">
                <div class="room-section">
                    <h3>ルームを作成</h3>
                    <div class="form-group">
                        <label>ルーム名</label>
                        <input type="text" id="room-name" placeholder="任意のルーム名">
                    </div>
                    <div class="form-group">
                        <label>パスワード（任意）</label>
                        <input type="password" id="room-password" placeholder="パスワード">
                    </div>
                    <div class="form-group">
                        <label>最大プレイヤー数</label>
                        <input type="number" id="room-max" min="2" max="50" value="3">
                    </div>
                    <div class="form-group">
                        <label>ルール</label>
                        <select id="room-rule">
                            <option value="classic">クラシック (標準)</option>
                            <option value="speed">スピード (短め)</option>
                            <option value="challenge">チャレンジ (問題多め)</option>
                        </select>
                    </div>
                    <div><button class="btn btn-primary" id="create-room-btn">ルームを作成</button></div>
                </div>
                <div class="room-section">
                    <h3>ルームに参加</h3>
                    <div class="form-group">
                        <label>ルームID</label>
                        <input type="text" id="join-room-id" placeholder="ルームIDを入力">
                    </div>
                    <div class="form-group">
                        <label>パスワード（必要なら）</label>
                        <input type="password" id="join-room-password" placeholder="パスワード">
                    </div>
                    <div><button class="btn btn-primary" id="join-room-btn">参加する</button></div>
                </div>
            </div>
            <div id="room-status" class="room-status"></div>
        </div>
    </div>

    <!-- Connection Error Modal -->
    <div id="connection-error-modal" class="modal">
        <div class="modal-content" style="max-width:400px;text-align:center;">
            <h3 style="color:#ff6b6b;margin-bottom:16px;">サーバー未接続</h3>
            <p style="margin-bottom:20px;opacity:0.9;">ゲームを開始するには、まずサーバーに接続してください。</p>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button class="btn btn-primary" onclick="gameManager.closeModal('connection-error-modal'); gameManager.showModal('startup-overlay');">接続設定へ</button>
                <button class="btn btn-secondary" onclick="gameManager.closeModal('connection-error-modal');">閉じる</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/debugger.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js?v=2.0"></script>

    <!-- Persistent Status Indicators -->
    <div id="persistent-status-container" style="display:none;">
    <div id="matchmaking-status"></div>
    <span class="waiting-badge" style="display:inline-block;">-</span>
    <button id="cancel-matchmaking-btn" class="btn btn-secondary">キャンセル</button>
    </div>

    <!-- Quick floating cancel button for matchmaking (shown when matchmaking active) -->
    <button id="quick-cancel-btn" class="btn-quick-cancel" style="display:none;">キャンセル</button>

    <div id="match-found-modal" class="modal">
        <div class="modal-content">
            <h2>対戦相手が見つかりました！</h2>
            <p>まもなくゲームを開始します...</p>
            <div id="match-found-countdown">5</div>
        </div>
    </div>

    <!-- Debug panel (only visible in development) -->
    <div id="debug-panel" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 10000; display: none;">
        <strong>Debug Panel</strong><br>
        <button onclick="debugTutorial()" style="margin: 2px; padding: 5px;">Debug Tutorial</button>
        <button onclick="forceMainMenu()" style="margin: 2px; padding: 5px;">Force Main Menu</button>
        <button onclick="resetTutorial()" style="margin: 2px; padding: 5px;">Reset Tutorial</button>
        <button onclick="localStorage.clear(); location.reload()" style="margin: 2px; padding: 5px;">Clear Storage</button>
        <button onclick="emergencyFix()" style="margin: 2px; padding: 5px; background: red; color: white;">EMERGENCY FIX</button>
    </div>

    <script>
        // Show debug panel in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            document.getElementById('debug-panel').style.display = 'block';
        }

        // Emergency fix function
        function emergencyFix() {
            console.log('=== EMERGENCY FIX ACTIVATED ===');

            // Close all modals
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.classList.remove('active'));

            // Hide tutorial overlay
            const tutorialOverlay = document.getElementById('tutorial-overlay');
            if (tutorialOverlay) {
                tutorialOverlay.classList.remove('active');
                tutorialOverlay.style.display = 'none';
            }

            // Show main menu
            const mainMenu = document.getElementById('main-menu');
            if (mainMenu) {
                mainMenu.style.display = 'block';
            }

            // Reset tutorial state
            if (window.gameManager) {
                window.gameManager.tutorialStep = 0;
                window.gameManager.tutorialSteps = null;
                localStorage.setItem('hasSeenTutorial', 'true');
            }

            // Remove tutorial highlights
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.remove());

            console.log('Emergency fix completed - main menu should be visible now');
            alert('緊急修正が完了しました！メインコンテンツが表示されるはずです。');
        }
    </script>

</body>
</html>
